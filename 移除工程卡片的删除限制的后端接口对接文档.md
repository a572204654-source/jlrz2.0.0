# 移除工程卡片删除限制的后端接口对接文档

## 一、需求概述

### 1.1 背景
前端工程管理页面需要支持删除工程卡片，即使该工程下存在监理日志。删除操作应允许用户继续执行，但需要在前端提示用户删除后无法恢复。

### 1.2 变更说明
- **之前**：后端可能限制删除有日志的工程（返回错误或拒绝删除）
- **现在**：后端允许删除有日志的工程，删除时自动处理关联的监理日志数据

## 二、接口规范

### 2.1 删除工程接口

#### 接口信息
- **请求方式**：`DELETE`
- **接口路径**：`/api/works/{id}`
- **Content-Type**：`application/json`

#### 请求参数

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| id | Number | Path | 是 | 工程ID |

#### 请求示例

```http
DELETE /api/works/123 HTTP/1.1
Host: your-api-domain.com
Authorization: Bearer {token}
Content-Type: application/json
```

#### 响应规范

**成功响应（200 OK）**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**失败响应（400/404/500）**

```json
{
  "code": 400,
  "message": "错误信息",
  "data": null
}
```

#### 业务规则

1. **删除限制移除**
   - ✅ 允许删除有监理日志的工程
   - ✅ 删除工程时，应同时处理关联的监理日志数据

2. **数据级联处理方案（二选一）**

   **方案A：级联删除（推荐）**
   - 删除工程时，同时删除该工程下的所有监理日志
   - 删除该工程下的所有附件（如果附件与工程关联）
   - 使用数据库外键约束或事务确保数据一致性

   **方案B：软删除**
   - 将工程标记为已删除（isDeleted = true）
   - 将关联的监理日志标记为已删除或设置为孤立状态
   - 保留数据用于后续恢复或审计

3. **权限验证**
   - 验证用户是否有权限删除该工程
   - 验证工程是否属于当前用户的项目

4. **错误处理**
   - 工程不存在：返回 404
   - 无权限删除：返回 403
   - 系统错误：返回 500

### 2.2 获取工程列表接口（日志数量字段）

#### 接口信息
- **请求方式**：`GET`
- **接口路径**：`/api/works`
- **Content-Type**：`application/json`

#### 请求参数

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| projectId | Number | Query | 是 | 项目ID |
| page | Number | Query | 否 | 页码，默认1 |
| pageSize | Number | Query | 否 | 每页数量，默认20 |
| keyword | String | Query | 否 | 搜索关键词（工程名称或编号） |

#### 响应规范

**成功响应（200 OK）**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "list": [
      {
        "id": 123,
        "workName": "工程名称",
        "workCode": "GC001",
        "unitWork": "单位工程",
        "color": "#0d9488",
        "isPinned": false,
        "logCount": 15,  // 监理日志数量（必填）
        "logStats": {    // 可选：详细统计信息
          "totalCount": 15,
          "monthCount": 5
        }
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20
  }
}
```

#### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| logCount | Number | 是 | 该工程下的监理日志总数，无日志时为 0 |
| logStats | Object | 否 | 日志统计信息（可选） |
| logStats.totalCount | Number | 否 | 总日志数 |
| logStats.monthCount | Number | 否 | 本月日志数 |

**注意**：前端会优先使用 `logCount` 字段，如果没有则尝试 `logStats.totalCount`、`logStats.total`、`stats.logCount`、`totalLogs` 等字段。

### 2.3 获取工程详情接口（日志数量字段）

#### 接口信息
- **请求方式**：`GET`
- **接口路径**：`/api/works/{id}`
- **Content-Type**：`application/json`

#### 请求参数

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| id | Number | Path | 是 | 工程ID |

#### 响应规范

**成功响应（200 OK）**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 123,
    "workName": "工程名称",
    "workCode": "GC001",
    "unitWork": "单位工程",
    "color": "#0d9488",
    "isPinned": false,
    "logCount": 15,  // 监理日志数量（必填）
    "stats": {       // 可选：统计信息
      "logCount": 15
    },
    "logStats": {    // 可选：详细统计信息
      "totalCount": 15,
      "monthCount": 5
    }
  }
}
```

**字段说明**：同工程列表接口的字段说明。

## 三、前端交互流程

### 3.1 删除流程

```
用户滑动工程卡片 → 点击删除按钮
    ↓
前端检查日志数量（调用 getWorkDetail 或使用列表中的 logCount）
    ↓
显示确认弹窗：
  - 有日志：显示"该工程下有X条监理日志，删除后将无法恢复。是否继续删除？"
  - 无日志：显示"确定要删除吗？删除后无法恢复。"
    ↓
用户确认 → 调用 DELETE /api/works/{id}
    ↓
后端处理删除（级联删除日志或软删除）
    ↓
返回成功 → 前端移除列表项并提示"删除成功"
```

### 3.2 数据加载流程

```
页面加载 → 调用 GET /api/works?projectId=xxx
    ↓
后端返回工程列表（包含 logCount 字段）
    ↓
前端解析并显示工程卡片
    ↓
删除时如需最新日志数，调用 GET /api/works/{id} 获取详情
```

## 四、数据库设计建议

### 4.1 级联删除方案（方案A）

**MySQL 示例**

```sql
-- 工程表
CREATE TABLE works (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  project_id BIGINT NOT NULL,
  work_name VARCHAR(255) NOT NULL,
  work_code VARCHAR(100) UNIQUE NOT NULL,
  -- 其他字段...
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

-- 监理日志表
CREATE TABLE supervision_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  work_id BIGINT NOT NULL,
  -- 其他字段...
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (work_id) REFERENCES works(id) ON DELETE CASCADE
);

-- 附件表（如果与工程关联）
CREATE TABLE attachments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  work_id BIGINT,
  log_id BIGINT,
  -- 其他字段...
  FOREIGN KEY (work_id) REFERENCES works(id) ON DELETE CASCADE,
  FOREIGN KEY (log_id) REFERENCES supervision_logs(id) ON DELETE CASCADE
);
```

### 4.2 软删除方案（方案B）

```sql
-- 工程表添加删除标记
ALTER TABLE works ADD COLUMN is_deleted TINYINT(1) DEFAULT 0;
ALTER TABLE works ADD COLUMN deleted_at DATETIME NULL;

-- 监理日志表添加删除标记
ALTER TABLE supervision_logs ADD COLUMN is_deleted TINYINT(1) DEFAULT 0;
ALTER TABLE supervision_logs ADD COLUMN deleted_at DATETIME NULL;

-- 删除时更新标记
UPDATE works SET is_deleted = 1, deleted_at = NOW() WHERE id = ?;
UPDATE supervision_logs SET is_deleted = 1, deleted_at = NOW() WHERE work_id = ?;
```

## 五、接口测试用例

### 5.1 删除有日志的工程

**测试步骤**：
1. 创建一个工程
2. 为该工程添加若干条监理日志
3. 调用删除接口删除该工程

**预期结果**：
- 返回 200 状态码
- 工程被删除
- 关联的监理日志被删除（级联删除）或标记为已删除（软删除）

### 5.2 删除无日志的工程

**测试步骤**：
1. 创建一个工程（不添加日志）
2. 调用删除接口删除该工程

**预期结果**：
- 返回 200 状态码
- 工程被删除

### 5.3 删除不存在的工程

**测试步骤**：
1. 使用不存在的工程ID调用删除接口

**预期结果**：
- 返回 404 状态码
- 错误信息："工程不存在"

### 5.4 无权限删除工程

**测试步骤**：
1. 使用其他用户的工程ID调用删除接口

**预期结果**：
- 返回 403 状态码
- 错误信息："无权限删除该工程"

### 5.5 获取工程列表（验证 logCount 字段）

**测试步骤**：
1. 创建多个工程，部分有日志，部分无日志
2. 调用获取工程列表接口

**预期结果**：
- 返回 200 状态码
- 每个工程对象都包含 `logCount` 字段
- `logCount` 值为该工程下的实际日志数量

## 六、注意事项

### 6.1 数据一致性
- 如果采用级联删除，确保数据库外键约束正确设置
- 如果采用软删除，确保查询时过滤已删除数据
- 建议使用数据库事务确保操作的原子性

### 6.2 性能优化
- 删除大量日志时，考虑批量删除或异步处理
- 为 `work_id` 字段添加索引以提升查询性能
- 定期清理软删除的数据（如果采用软删除方案）

### 6.3 安全性
- 验证用户权限，防止越权删除
- 记录删除操作日志，便于审计
- 敏感操作建议添加二次确认（后端可提供配置项）

### 6.4 兼容性
- 确保 `logCount` 字段始终返回，即使为 0
- 保持接口响应格式的一致性
- 前端已兼容多种字段名（logCount、logStats.totalCount 等），但建议统一使用 `logCount`

## 七、接口变更清单

| 接口 | 变更类型 | 变更内容 | 影响范围 |
|------|---------|---------|---------|
| DELETE /api/works/{id} | 功能变更 | 移除删除限制，允许删除有日志的工程 | 工程删除功能 |
| GET /api/works | 字段增强 | 响应中必须包含 logCount 字段 | 工程列表展示 |
| GET /api/works/{id} | 字段增强 | 响应中必须包含 logCount 字段 | 工程详情展示 |

## 八、版本信息

- **文档版本**：v1.0
- **创建日期**：2024年
- **最后更新**：2024年
- **适用前端版本**：1.1.1+

## 九、联系方式

如有接口对接问题，请联系：
- 前端开发：xxx
- 后端开发：xxx
- 产品经理：xxx

---

**文档结束**

