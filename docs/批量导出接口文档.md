# 监理日志批量导出接口文档

## 接口信息

| 项目 | 说明 |
|------|------|
| 接口地址 | `POST /api/supervision-logs/export-batch` |
| 请求方式 | POST |
| Content-Type | application/json |
| 认证方式 | Bearer Token（Header: Authorization） |
| 响应类型 | application/vnd.openxmlformats-officedocument.wordprocessingml.document |

---

## 请求参数

### Headers

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | string | 是 | Bearer {token}，用户登录后获取的token |
| Content-Type | string | 是 | application/json |

### Body 参数

```json
{
  "logIds": [1, 2, 3],
  "projectName": "胶州湾大桥",
  "workName": "胶州湾一段",
  "fileName": "胶州湾一段_批量导出_2025-12-03.docx"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| logIds | number[] | 是 | 要导出的监理日志ID数组，最多100条 |
| projectName | string | 否 | 项目名称，用于生成首页信息，不传则使用第一条日志的项目名称 |
| workName | string | 否 | 工程名称，用于生成首页信息，不传则使用第一条日志的工程名称 |
| fileName | string | 否 | 导出文件名，不传则自动生成为 `监理日志批量导出_YYYY-MM-DD.docx` |

---

## 响应说明

### 成功响应

- **状态码**: 200
- **Content-Type**: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- **Content-Disposition**: `attachment; filename="..."; filename*=UTF-8''...`
- **响应体**: Word文档二进制流

### 错误响应

```json
{
  "code": 400,
  "message": "请选择要导出的日志",
  "data": null,
  "timestamp": 1701609600000
}
```

| 状态码 | code | message | 说明 |
|--------|------|---------|------|
| 400 | 400 | 请选择要导出的日志 | logIds为空或不是数组 |
| 400 | 400 | 单次最多导出100条日志 | logIds超过100条 |
| 404 | 404 | 未找到可导出的日志 | 所有logIds对应的日志不存在或无权访问 |
| 500 | -1 | 批量导出失败 | 服务器内部错误 |

---

## 前端调用示例

### JavaScript/TypeScript

```javascript
/**
 * 批量导出监理日志Word文档
 * @param {number[]} logIds - 日志ID数组
 * @param {object} projectInfo - 项目信息
 * @param {string} fileName - 文件名
 */
async function exportWordBatch(logIds, projectInfo, fileName) {
  const response = await fetch('/api/supervision-logs/export-batch', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${getToken()}`
    },
    body: JSON.stringify({
      logIds,
      projectName: projectInfo?.projectName || '',
      workName: projectInfo?.workName || '',
      fileName
    })
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.message || '导出失败')
  }

  // 获取文件名
  const disposition = response.headers.get('Content-Disposition')
  let downloadFileName = fileName || '批量导出.docx'
  if (disposition) {
    const match = disposition.match(/filename\*=UTF-8''(.+)/)
    if (match) {
      downloadFileName = decodeURIComponent(match[1])
    }
  }

  // 下载文件
  const blob = await response.blob()
  const url = window.URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = downloadFileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  window.URL.revokeObjectURL(url)
}
```

### uni-app/微信小程序

```javascript
/**
 * 批量导出监理日志Word文档
 */
async function exportWordBatch(logIds, projectInfo, fileName) {
  const token = uni.getStorageSync('token')
  
  return new Promise((resolve, reject) => {
    uni.request({
      url: `${BASE_URL}/api/supervision-logs/export-batch`,
      method: 'POST',
      header: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      data: {
        logIds,
        projectName: projectInfo?.projectName || '',
        workName: projectInfo?.workName || '',
        fileName
      },
      responseType: 'arraybuffer',
      success: (res) => {
        if (res.statusCode === 200) {
          // 保存文件到本地
          const fs = uni.getFileSystemManager()
          const filePath = `${wx.env.USER_DATA_PATH}/${fileName}`
          
          fs.writeFile({
            filePath,
            data: res.data,
            encoding: 'binary',
            success: () => {
              // 打开文件
              uni.openDocument({
                filePath,
                fileType: 'docx',
                success: () => resolve(filePath),
                fail: reject
              })
            },
            fail: reject
          })
        } else {
          reject(new Error(res.data?.message || '导出失败'))
        }
      },
      fail: reject
    })
  })
}
```

---

## 生成的Word文档结构

### 第一页：项目信息页

| 内容 | 说明 |
|------|------|
| 标题 | "监理日志批量导出" |
| 项目名称 | 传入的projectName或第一条日志的项目名称 |
| 工程名称 | 传入的workName或第一条日志的工程名称 |
| 日志数量 | 导出的日志总条数 |
| 日期范围 | 所有日志的最早日期 至 最晚日期 |
| 导出时间 | 当前时间 |
| 日志目录 | 所有日志的日期和天气列表 |

### 后续页面：日志内容

每条日志占一页，包含：
- 单位工程名称、单位工程编号
- 日期（含星期）
- 气象
- 工程动态
- 监理工作情况
- 安全监理工作情况
- 记录人、审核人签名

---

## 注意事项

1. **权限验证**: 只能导出当前登录用户创建的日志
2. **数量限制**: 单次最多导出100条日志
3. **排序规则**: 日志按日期升序排列
4. **文件名编码**: 支持中文文件名，使用UTF-8编码
5. **超时处理**: 大量日志导出可能耗时较长，建议前端设置较长的超时时间（如60秒）

---

## 更新日志

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2025-12-03 | 初始版本，支持批量导出监理日志 |
